// Инициализация Supabase
const supabase = supabase.createClient(
  'https://ваш-проект-id.supabase.co',
  'ваш-публичный-ключ'
);

// Создание Vue приложения
const app = Vue.createApp({
  data() {
    return {
      loading: true,
      user: null,
      isLogin: true,
      email: '',
      password: '',
      error: '',
      products: [],
      showAddProduct: false,
      editingProduct: null,
      newProduct: {
        name: '',
        price: 0,
        description: ''
      }
    }
  },
  methods: {
    // Метод авторизации
    async handleAuth() {
      try {
        this.error = '';
        if (this.isLogin) {
          const { data, error } = await supabase.auth.signInWithPassword({
            email: this.email,
            password: this.password
          });
          if (error) throw error;
          this.user = data.user;
        } else {
          const { data, error } = await supabase.auth.signUp({
            email: this.email,
            password: this.password
          });
          if (error) throw error;
          this.user = data.user;
        }
        this.email = '';
        this.password = '';
        await this.loadProducts();
      } catch (error) {
        console.error('Ошибка авторизации:', error);
        this.error = error.message;
      }
    },

    // Загрузка товаров
    async loadProducts() {
      try {
        if (!this.user) {
          console.log('Пользователь не авторизован');
          return;
        }
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .eq('user_id', this.user.id);
        
        if (error) throw error;
        this.products = data || [];
        console.log('Товары загружены:', this.products);
      } catch (error) {
        console.error('Ошибка при загрузке товаров:', error);
        this.error = error.message;
      }
    },

    // Сохранение товара
    async saveProduct() {
      try {
        if (!this.user) {
          this.error = 'Пользователь не авторизован';
          return;
        }

        const productData = {
          name: this.newProduct.name,
          price: this.newProduct.price,
          description: this.newProduct.description,
          user_id: this.user.id
        };

        let response;
        if (this.editingProduct) {
          response = await supabase
            .from('products')
            .update(productData)
            .eq('id', this.editingProduct.id);
        } else {
          response = await supabase
            .from('products')
            .insert([productData]);
        }

        if (response.error) throw response.error;

        await this.loadProducts();
        this.newProduct = { name: '', price: 0, description: '' };
        this.editingProduct = null;
        this.showAddProduct = false;
      } catch (error) {
        console.error('Ошибка при сохранении товара:', error);
        this.error = error.message;
      }
    },

    // Удаление товара
    async deleteProduct(id) {
      if (!confirm('Вы уверены, что хотите удалить этот товар?')) return;
      try {
        const { error } = await supabase
          .from('products')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        await this.loadProducts();
      } catch (error) {
        console.error('Ошибка при удалении товара:', error);
        this.error = error.message;
      }
    }
  },

  // Хук mounted
  async mounted() {
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) throw error;
      
      if (session) {
        this.user = session.user;
        await this.loadProducts();
      }

      // Подписка на изменения авторизации
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session) {
          this.user = session.user;
          this.loadProducts();
        } else if (event === 'SIGNED_OUT') {
          this.user = null;
          this.products = [];
        }
      });
    } catch (error) {
      console.error('Ошибка при инициализации:', error);
      this.error = error.message;
    } finally {
      this.loading = false;
    }
  }
});

// Монтирование приложения
app.mount('#app');
</script>
</body>
</html> 